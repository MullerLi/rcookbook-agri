# ANOVA

```{r message=FALSE, warning=FALSE, include=FALSE}
pkgs <- c('car','MASS','magrittr','tidyverse','lme4','lmerTest','multcomp','agricolae','dplyr','lsmeans','emmeans','psych')
if (!any(pkgs %in% installed.packages())) {install.packages(pkgs[!pkgs %in% installed.packages()])}
invisible(lapply(pkgs , library , character.only=TRUE))
```

ANOVA是變異數分析(analysis of variance)的英文縮寫，當想要了解3個以上平均值之間是否有差異時，可以利用ANOVA。

若當平均值只有2個，計算ANOVA就等同於計算相同變異數相同的T檢定，此時ANOVA計算的F值為T值的平方。

## 前提假設

+--------------------+----------------------------------------------------------+--------------------------------+
| 前提假設           | 檢定(R)                                                  | 補救方案                       |
+====================+==========================================================+================================+
| 樣本常態與誤差獨立 | qqnorm(iris\$Sepal.Length)：點要接近對角線，否則不符常態 | Box-Cox數據轉換 (MASS::boxcox) |
|                    |                                                          |                                |
|                    | shapiro.test(iris\$Sepal.Length)：顯著則不符常態         |                                |
+--------------------+----------------------------------------------------------+--------------------------------+
| 變異數均值         | bartlett.test(Sepal.Length\~Species, data = iris)        | Box-Cox數據轉換 (MASS::boxcox) |
|                    |                                                          |                                |
|                    | car::leveneTest(Sepal.Length\~Species, data = iris)      |                                |
|                    |                                                          |                                |
|                    | 顯著代表變異數不均值                                     |                                |
+--------------------+----------------------------------------------------------+--------------------------------+

1.  樣本與誤差具常態性且彼此獨立

$\epsilon \sim {\sf NID}(0,\sigma^2)$

2.  變異數均值假設

-   樣本是來自變異數相等的族群，譬如利用某機器量測一群稻穀樣本的重量，每次量測時，機器顯示的重量，都會受到機器本身設定的影響，呈現真實重量的固定百分比，因此具有這一群稻穀樣本會有相等的變異數。

-   當違反假設，且變因是固定型效應，在處理重複數量均衡（彼此相同）時，對Fo僅有微弱的影響；但在處理數不均衡時，則會使顯著水準或型I錯誤率與預期值偏離。當變因是隨機型效應時，不論處理是否均衡，違反假設都會造成極大影響。

### 檢驗方式

1.  常態性檢定：

-   機率分布圖(QQ plot)：將殘差計算出來，從大排到小，按數據點在圖形上。如果屬於常態分佈，會像是一條直線，不會偏離太多。
-   使用`qqnorm`查看QQ-plot

```{r include = TRUE}
qqnorm(iris$Sepal.Length)
```

可以看出點很貼近線，數據應該符合常態。

-   使用`shapiro.tes`檢定，顯著則代表不符合常態。

```{r include = TRUE}
shapiro.test(iris$Sepal.Length)
```

因為*P*值不小於0.05，所以得知數據是常態分佈的資料。

---

2.  獨立性與變異數均值的檢定：

-   順序與殘差圖：殘差如不獨立，彼此會有相關性，會一連串的正或負。將實驗進行的時間順序為X軸，殘差為Y軸作圖，應該是無結構的。
-   配適值與殘差圖：x軸為配適值(fitted value)，y軸為殘差(residuel)作圖。若殘差彼此之間獨立，ϵij畫出的圖不會有結構。喇叭狀代表違反獨立性與變異數均值假設。 $$\hat y_{ij}=\bar y_{i.}+\epsilon_{ij}$$



---


3.  變異數均值的檢定： $H_0:\sigma_1^2=\sigma_2^2=...=\sigma_a^2$ $H_1:至少有一個\sigma_i^2不一樣$

-   Barlett's test：顯著代表變異數不相等
-   Levene's test：顯著代表變異數不相等。

```{r}
leveneTest(iris$Sepal.Length~iris$Species)
```

```{r}
bartlett.test(iris$Sepal.Length~iris$Species)
```

上述兩個檢定皆為顯著，顯示iris數據的Sepal.Length在Species之間違反變異數相等的假說。

## 非常態資料的轉換

下面是常見的資料轉換方式：

1.  開根號
2.  取log
3.  倒數+根號
4.  倒數
5.  Box-Cox轉換：先求$\lambda$值，計算log-likeihood峰值的lambda值，根據$\lambda$對觀測值取一個函數。實際上，Box-Cox轉換就包含了平方根、log、倒數等函數。

利用{MASS}`boxcox`可以計算出$\lambda$值，但是後續取函數部分需要自行作業。因此我寫了一個函數`nboxcox`來完成常態性檢定與數據轉換，如果數據是常態，就不執行boxcox轉換；反之，則回傳轉換後數據。


```{r eval=FALSE, include=FALSE}
data(iris)
# 開根號
iris$Sepal.Length <- sqrt(iris$Sepal.Length)
# 取log
iris$Sepal.Length <- log(iris$Sepal.Length)
# 倒數根號
iris$Sepal.Length <- sqrt((iris$Sepal.Length)^(-1))
# 倒數
iris$Sepal.Length <- (iris$Sepal.Length)^(-1)
```

---

```{r}
# Box-Cox transform
nboxcox<-function(data , y){
  require(tidyverse)
  data_y<-unlist(as.vector(select_if(data[y],is.numeric)),use.names = F)
  shapiro_out <- data_y %>% shapiro.test()
  if (shapiro_out$p.value < 0.05) {
    cat('\n The variable',paste0("'",y,"'"),'is not normality.\n')
    require(MASS)
    forMu <- formula( paste0(as.character(y),'~1'))
    bc    <- boxcox(forMu,data = data)
    lambda<- bc$x[which.max(bc$y)]
    if (lambda != 0){
      newy <- (　data_y^(lambda)　-1)/lambda
      print(newy)
    }else if(lambda == 0 ){
      newy <- log(data_y)
      print(newy)}}
  else if(shapiro_out$p.value >= 0.05){
    cat('The variable',paste0("'",y,"'"), 'is normality.\nReturning original data.\n')
    return(data_y)}}

# 範例
nboxcox(iris,'Sepal.Length')
```

## 線性模式

進行隨機設計(complete design, CRD)、完全隨機區集設計(random complete block design, RCBD)等試驗設計時，其實是將觀測值放進一個線性模式裡面來分析。

舉例來說，1個包含3種水稻品種產量試驗，採用CRD，可以寫成下面線性模式：

$$Y_{ij}=\mu+\alpha_i+\epsilon_{ij}$$

換句話說： $$A品種產量 = 產量總平均值 + 品種A的影響 + 隨機誤差$$ $$B品種產量 = 產量總平均值 + 品種B的影響 + 隨機誤差$$

品種A和品種B是影響產量變化的主要原因，因此稱為變因。在R中，可以直接用`formula`表示。總平均跟隨機誤差可以不用寫，直接寫變因即可。

```{r}
as.formula(yield ~ variety)
```

`formula`物件的左方為觀測值，通常是數量資料；右方是影響觀測值的變因(類別型)或是共變異數(連續型)。不同的試驗設計就會有不同的線性模式，只包含處理的話就是CRD、包含區集就是RCBD、包含多因子與交感就是復因子試驗。較複雜的設計(像是套層、裂區、條區，也會根據變因而有不同寫法。


```{r eval = FALSE}
# CRD
yield ~ A

# RCBD
yield ~ A + block

# Factorial Experiments
yield ~ A + B + A*B + block 

# Nested Design
yield ~ A + B + A/B 
```
## ANOVA

## LSD test

## generate the table

## Plot the data
